-# LICENSE
-#
-# MIT License
-#
-# Copyright (c) 2017-2018 Cryptomover
-#
-# Permission is hereby granted, free of charge, to any person obtaining a copy
-# of this software and associated documentation files (the "Software"), to deal
-# in the Software without restriction, including without limitation the rights to
-# use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
-# of the Software, and to permit persons to whom the Software is furnished to do
-# so, subject to the following conditions:
-#
-# The above copyright notice and this permission notice shall be included in all
-# copies or substantial portions of the Software.
-#
-# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
-# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
-# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
-# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
-# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
-# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
-# THE SOFTWARE.
-#
.card#advanced-settings-card{"data-address": @address}
  .card-header
    %h1 Advanced Settings
  .card-body
    #accordionOne
      .card
        #headingOne.card-header
          .row
            .col-11
              %h5.text-danger Change Threshold
            .col-1.ml-auto
              %button#buttonOne.btn.btn-link{"aria-controls" => "collapseOne", "aria-expanded" => "true", "data-target" => "#collapseOne", "data-toggle" => "collapse"}
                %i.fas.fa-chevron-circle-down
        #collapseOne.collapse{"aria-labelledby" => "headingOne", "data-parent" => "#accordion"}
          .card-body
            = render partial: 'shared/change_threshold_form'
    #accordionTwo.mt-3
      .card
        #headingTwo.card-header
          .row
            .col-11
              %h5.text-danger Add/Remove Signer
            .col-1.ml-auto
              %button#buttonTwo.btn.btn-link{"aria-controls" => "collapseTwo", "aria-expanded" => "true", "data-target" => "#collapseTwo", "data-toggle" => "collapse"}
                %i.fas.fa-chevron-circle-down
        #collapseTwo.collapse{"aria-labelledby" => "headingTwo", "data-parent" => "#accordion"}
          .card-body
            = render partial: 'shared/add_remove_signer_form'
    #progressbar.mt-2
      .progress-label
        Processing. Please Wait...

%script{src: "https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/0.8.0/stellar-sdk.min.js"}
:javascript
  $('#buttonOne').click(function() {
    if ($(this).find($("i")).hasClass('fa-chevron-circle-down')) {
      $(this).find($("i")).removeClass('fa-chevron-circle-down').addClass('fa-times-circle')
    } else {
      $(this).find($("i")).removeClass('fa-times-circle').addClass('fa-chevron-circle-down')
    }
  })
  $('#buttonTwo').click(function() {
    if ($(this).find($("i")).hasClass('fa-chevron-circle-down')) {
      $(this).find($("i")).removeClass('fa-chevron-circle-down').addClass('fa-times-circle')
    } else {
      $(this).find($("i")).removeClass('fa-times-circle').addClass('fa-chevron-circle-down')
    }
  })

  $('#crtr-chng-thrshld-btn').click(function() {
    var low = $('#low-threshold').data("low")
    var med = $('#med-threshold').data("med")
    var high = $('#high-threshold').data("high")
    var newLow = document.getElementById('low-threshold').value.replace(/\s/g,'')
    var newMed = document.getElementById('med-threshold').value.replace(/\s/g,'')
    var newHigh = document.getElementById('high-threshold').value.replace(/\s/g,'')
    var seed = document.getElementById('secret-seed-one').value.replace(/\s/g,'')
    var doNotSign = $('#inlineCheckbox1').is(":checked")

    if (seed.length == 0) {
      $("#layout-alert").show()
      $("#layout-alert").html("ERROR! Please enter your private seed.")
      var scrollPos =  $("#layout-alert").offset().top;
      $(window).scrollTop(scrollPos);
    } else if (!allThresholdsAreValid(newLow, newMed, newHigh)) {
      $("#layout-alert").show()
      $("#layout-alert").html("ERROR! Invalid Threshold Limit. It must be an integer between 0-255.")
      var scrollPos =  $("#layout-alert").offset().top;
      $(window).scrollTop(scrollPos);
    } else {
      disableAllAdvSettings()
      $('#layout-alert').hide()
      progressBar()
      var server = new StellarSdk.Server('https://horizon.stellar.org')
      StellarSdk.Network.usePublicNetwork()
      var publicKey = $('#advanced-settings-card').data("address")
      var keypair = StellarSdk.Keypair.fromSecret(seed)
        server.loadAccount(publicKey)
          .then(function(account) {
            var transaction = new StellarSdk.TransactionBuilder(account)
            .addOperation(StellarSdk.Operation.setOptions({
              lowThreshold: parseInt(newLow)
              })).build()
            xdr = transaction.toEnvelope().toXDR('base64')
            $("#progressbar").hide()
            $('#ct-transaction').html("Transaction Object: <br>" + xdr)
            var scrollPos =  $("#ct-transaction").offset().top;
            $(window).scrollTop(scrollPos);
        })
    }
  })
